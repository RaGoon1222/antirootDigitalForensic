# Memory 분석
>*주로 윈도우에 관한 이야기만 다룬다.*  
포렌식에서 빼놓을 수 없는 메모리 분석에 대한 이야기이다.  
메모리에는 프로세스가 사용한 데이터와 프로세스 자체, 웹 브라우저를 통해 전송된 정보, 복호화된 데이터 등이 기록되어 있다.  
메모리 분석에 대한 연구는 (이 책 기준)현재진행형이므로 파일시스템 분석이나 레지스트리 분석과 비교할 때는 아직 부족하지만 시스템의 많은 정보를 알아낼 수 있으므로 메모리에 대해 반드시 알고 정보 활용 능력을 길러야 한다.

### 메모리 분석의 관심과 장점, 단점
1. 하드디스크에서 실행되지 않고 메모리상에서 바로 실행되는 악성코드의 존재  
이런 경우, 하드디스크를 이미지 파일로 만들어 분석한다 하더라도 악성 파일의 실행 원본 파일이나 흔적을 하드디스크에서 찾을 수 없으므로 메모리 분석이 필요하다.
2. 사용자 응용 프로그램의 프라이버시 보호 기능 강화  
요즘은 암호화나 개인정보보호 프로그램이 일반화되어 범용되어진다.  
이러한 프로그램들은 일반 사용자의 개인 파일들을 보호하지만, 시스템에 침투한 악성코드 또한 보호하는 경우가 발생한다.   
개인정보보호 프로그램이 악성코드 판별 기능이 없기 때문이다.   
이러한 상황에서 악성코드를 분석하려면 메모리 영역을 분석해야한다.  
실행 파일들은 메모리 영역에서는 복호화되어 실행되기 때문이다.  
3. [안티 포렌식(Anti Forensic)](https://en.wikipedia.org/wiki/Anti-computer_forensics)기술의 확산으로 하드 드라이브에 존재하고 있는 데이터의 무결성 불완전  
안티 포렌식 기술은 [루트킷](https://ko.wikipedia.org/wiki/%EB%A3%A8%ED%8A%B8%ED%82%B7)의 경우 나쁘다고 할 수 있지만 데이터 완전 삭제 기술 같은 경우, 일반 사용자들에게는 개인정보파일들을 유출되지 못하도록 하는 기술이기 때문에 좋다고 할 수도 있다.  
아무튼 루트킷이나 데이터 완전 삭제 기술의 경우 무결성을 저해하는 행위이기 때문에 하드디스크가 아닐 경우 메모리에서밖에 복구하지 못한다.  
메모리의 데이터도 완전하지는 않지만 그래도 수집하여 분석하는 것이 도움되기 때문에 메모리 영역을 분석해 데이터를 추출해야 한다.  

위와 같은 이유로 포렌식 관점의 메모리 분석 분야가 관심받기 시작했지만 (이 책 기준)아직까지는 발전 단계가 낮다.  
메모리 분석을 위한 선행 지식이 방대하고 구조는 운영체제마다 다른데다 세부적으로 패치에 따라 달라지기 때문이다. 
 
Live Response에 메모리 분석 과정이 포함될 수 있는데 이는 메모리 분석을 통해 얻는 정보가 대부분 Live Response 정보와 일치하기 때문이다.  
그렇기에 Live Response 과정에 메모리 분석을 넣는 것은 조사관 판단에 달려 있다.  
얻어지는 정보가 비슷하거나 일치한다고 해서 서로 대체하거는 것이 불가능하다.  
Live Response는 메모리 분석과 비교하였을 때 다음과 같은 단점을 지니고 있다.  

1. 도구의 신뢰성 저하  
Live Response 도구들은 대부분 윈도우에서 기본적으로 제공학는 API에 의존하기 때문에 악의적인 해커나 악성 프로그램이 윈도우의 DLL파일을 변조하거나 교체한다면 해당 DLL을 사용하는 도구는 신뢰성이 떨어질 것이다.
2. 분석의 반복성이 없음  
Live Response의 정보는 모두 휘발성으로 다음에 다시 수집한다고 해서 데이터가 일치할 것이라 보장할 수 없다.  
따라서 Live Response의 데이터가 합법적인 절차를 통해 수집했다고 해도 증명하지 못할 수 있다.  
객관적인 증명을 위해서는 동일한 환경에서 동일한 수행이나 입력이 되었을 때 동일한 결과가 나와야 하는데 Live Response는 그렇지 않다.  
3. 분석의 다양성이 없음  
조사관은 휘발성 정보를 증거나 참고용으로 제출했으나 상대편에서 반박하면 객관적인 증명을 위해 다른 방법으로 조사하여 동일한 결과가 나온다는 사실을 증거로 제출해야 한다.  
따라서 조사관은 하나의 휘발성 정보를 수집하기 위해 여러 가지 방법을 사용해야 한다.  
하지만 Live Response는 수행 과정에서는 여러 방법을 사용해 정보를 수집할 수 있지만 조사가 끝나면 다시 정보를 수집할 방법이 없다.  

위와 같이 Live Response는 단점을 가지는 반면 메모리 분석은 Live Response에 대해 다음과 같은 장점을 가지고 있다.  

1. 도구의 신뢰성 보장  
메모리 분석 도구에 사용되는 API는 윈도우의 프로세스/메모리 관련 API가 아닌, 파일시스템의 API이기 때문에 API변조와 상관없이 얻어진 결과이기 때문에 신뢰성을 가진다.  
2. 분석의 반복성 보장  
메모리 분석 대상은 변하지 않기 때문에 언제든지 조사를 반복할 수 있으며 Live Response와 달리 동일한 입력값을 통해 동일한 결과값을 가진다.  
3. 분석의 다양성 보장  
메모리 분석 대상은 Live Response와 달리 조사가 끝이 나도 존재하기 때문에 언제든지 다른 조사 방법이나 새로운 조사 방법을 적용하여 조사를 재개할 수 있다.  

Live Response와 메모리의 장점과 단점에 대해 알아보았다.  
한쪽으로 치우치는 분석보다는 서로 상호작용하는 분석의 수행이 중요하다.  

### 메모리 분석에 앞서 알아두어야 할 사항  
1. 메모리 덤프 개요  
메모리 분석에 앞서 해야 할 작업은 메모리 덤프 파일을 시스템으로부터 얻는 것이다.  
메모리 덤프 방법으로는 다음 네 가지가 있다.
    1. 하드웨어를 이용한 방법
    2. 소프트웨어 도구를 이용한 방법
    3. OS 크래시 덤프를 이용한 방법 
    4. 하이버네이션 파일을 이용한 방법  

각 방법은 장점과 단점을 가지고 있어 조사관의 판단에 따라 상황에 맞게 적절하게 사용해야 한다.  
순서대로 차근차근 알아보도록 하자.  

#### 하드웨어를 이용한 메모리 덤프  
하드웨어로 덤프를 수행할 경우 [DMA](https://ko.wikipedia.org/wiki/%EC%A7%81%EC%A0%91_%EB%A9%94%EB%AA%A8%EB%A6%AC_%EC%A0%91%EA%B7%BC)기능을 이용해 OS특성에 상관없이 메모리 덤프 수행이 가능하다.  
또한 응용프로그램을 실행하는 것이 아니기 때문에 시스템 메모리에 어떠한 영향도 미치지 않아 소프트웨어 방식보다 조금 더 정확한 메모리 덤프가 가능하다.  
하지만 덤프 과정의 안전성이 검증되지 않아 시스템에 [크래시](https://ko.wikipedia.org/wiki/%EC%B6%A9%EB%8F%8C_(%EC%BB%B4%ED%93%A8%ED%8C%85))를 일으키는 경우가 있다.  
최신 마더보드의 경우 [MIMO](https://ko.wikipedia.org/wiki/MIMO) 기능을 가지고 있는데 악의적인 사용자가 이 기능으로 메모리 덤프 과정을 방해할 가능성이 있다.  

하드웨어를 이용한 메모리 덤프 방법에는 다음과 같은 종류가 있다.  

1. PCI 장치  
일반적으로 잘 알려진 메모리 덤프 방법으로 Tribble이라는 기기를 사용하며 이는 실험적인 장치이므로 구매가 불가능하다.  
2. Firewire 장치  
윈도우에서 사용이 가능하며 대상 컴퓨터에 무언가를 설치할 필요가 없고, PCI 장치 방법보다 간편하다.

하드웨어를 이용한 방법은 실습할 방법이 없어 설명만으로 공부해야한다.(하려면 장비 구입 요함)  
그러므로 일단은 이런 방법이 있다는 것만 알고 넘어가자.  

#### 소프트웨어를 이용한 메모리 덤프
가장 좋은 장점은 즉석에서 메모리 덤프를 만들 수 있다는 점이다.  
이 때문에 하드웨어를 이용한 방법보다는 소프트웨어를 이용한 방법이 좀 더 많이 쓰이고 있다.  
하지만 OS의 API에 의존하기 때문에 악의적인 사용자가 API를 조작하게 되면 메모리 덤프 결과도 조작되는 셈이 된다.  

이제 소프트웨어를 통한 메모리 덤프 방법에는 어떤 것들이 있는지 알아보자.   

1. DD  
유닉스 도구 중 하나로 GNU License로 배포된다. 간단한 사용법과 좋은 결과물이 장점이다.  
윈도우에서도 적용이 가능한 윈도우 버전도 존재한다.  
DD는 사용자가 접근 가능한 모든 데이터를 바이트 또는 [블록](https://ko.wikipedia.org/wiki/%EB%B8%94%EB%A1%9D_(%EC%BB%B4%ED%93%A8%ED%8C%85)) 단위로 복사하는데 복사하려는 영역을 OS가 인식하지 못하거나, 사용자 권한이 낮아 접근하지 못하는 영역이거나, 지원하는 API가 없는 경우를 제외하고는 모든 시스템 데이터를 덤프할 수 있다.  
DD는 주로 리눅스에서 사용하고, 포맷 이미지는 Raw 데이터 포맷 이미지를 사용한다.  
장점으로는 데이터의 형태를 그대로 덤프한다는 점이고, 단점은 부가정보의 미제공으로 분석에 시간이 오래걸린다는 것이다.  
2. KntDD  
이 도구는 메모리 덤프를 네트워크로 전송하는 기능을 포함하고 있으며 메모리 덤프를 윈도우 크래시 덤프 포맷으로 변환하는 기능도 가지고 있다.  
하지만 이 도구는 보안전문회사나 군, 정부기관에만 제공되어 일반인들은 사용이 불가능하다.  
3. MDD  
메모리 덤프만을 위해 만들어진 도구이다. Windows XP SP2(32bit) 이후 버전에서도 문제없이 수행 가능하지만 업데이트가 되지 않는다.  
그래도 오픈 소스이기 때문에 사용자가 직접 수정하여 사용이 가능하기 때문에 이 부분은 별다른 문제가 되지 않는다.  
4. WIN32(64)DD  
이 도구 또한 MDD처럼 멤리 덤프 전용으로 개발된 도구이다.  
많은 기능을 포함하며, 지원하는 윈도우 버전이 많다.  
기본적으로 로우 포맷을 지원하고 추가로 크래시 포맷과 하이버네이션 포맷을 지원한다.  
네트워크 전송 기능도 가지고 있으며 64bit 시스템 지원과 4GB 이상의 메모리 덤프 또한 지원한다.  
5. Fastdd  
제작자의 말에 따르면 win32dd보다 빠르다고 한다.  
32bit, 64bit를 모두 지원한다.  
6. 기타 상용 도구  
 * FastDump  
CLI 기반의 도구이다.  
 * Pro Discover IR  
메모리 덤프 전용이 아닌 침해사고용으로 개발된 도구이다.  
 * EnCase Enterprise
 * AccessData Enterprise  
기업 환경에서의 네트워크에 있는 컴퓨터의 메모리 덤프를 수집하는데 목적이 있다.  

#### OS Crash dump  
OS가 시스템에 일어난 오류문제의 원인을 찾기 위해 생성되는 메모리 덤프를 말한다.  

__크래시 덤프 생성과정__  
[BSOD](https://en.wikipedia.org/wiki/Blue_Screen_of_Death)이 발생하면 OS는 오류문제를 찾기 위해 메모리를 덤프하여 파일로 저장한다.  
일반적으로 XP는 디스크의 2GB의 여유 저장 공간이 있으면 크래시 덤프 파일(= 전체 메모리 덤프는 메모리 크기 + 300MB의 크기로 생성된다)을 생성하며 Win7의 경우 25GB 이상의 여유 공간이 있어야만 크래시 덤프 파일을 생성한다.  

![HowToMakeCrashDump](https://github.com/RaGoon1222/antirootDigitalForensic/blob/master/week_1/img/HowToMakeCrashDump.PNG?raw=true)

Win7의 경우 크래시 덤프 파일을 생성할 때 조건으로 여유 디스크 공간의 크기를 확인하는데 이는 디스크 용량이 충분하지 못한 상황에서 메모리의 덤프를 막아 시스템 리소스 낭비를 줄이자는 의도이다.  
